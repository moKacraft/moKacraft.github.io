<!DOCTYPE html>
<html>

<head>
  <style>
    /* https://blog.koley.in/2019/339-bytes-of-responsive-css */
  </style>
</head>

<body>
  <h1>Reddit but lighter</h1>
</body>

<script>
  const LOGGER = true;
  var map = new Map();
  loadURL("https://cors-hackity.herokuapp.com/https://reddit.com/r/all/.json?sort=hot&limit=15", onDataLoaded);

  function loadURL(url, callBack) {
    if (document.getElementById("loadMore")) {
      document.getElementById("loadMore").remove();
    }

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.setRequestHeader("Accept", "application/json");
    xhr.onloadend = onLoadEnd(xhr, callBack);
    xhr.send();
  }

  function onLoadEnd(request, callBack) {
    return function () {
      var status = request.status;
      var result = String(request.response);
      if (status >= 200 && status < 300) callBack(result);
    };
  }

  function onDataLoaded(object) {
    object = JSON.parse(object);
    logger(object);

    for (article in object.data.children) {
      var infos = object.data.children[article];
      map.set(infos.data.name, JSON.stringify(infos));

      addArticle(infos);
    }
    var url = "https://cors-hackity.herokuapp.com/https://reddit.com/r/all/.json?sort=hot&limit=15&after=" + object.data.after;

    addButton('loadMore', 'Load more', 'height:5vh;width:100vw', url, function () { loadURL(url, onDataLoaded) });
  }

  function addButton(id, textContent, cssText, url, callback) {
    var loadMore = document.createElement('button');
    loadMore.id = id;
    loadMore.textContent = textContent;
    loadMore.style.cssText = cssText;
    loadMore.onclick = callback;

    document.body.appendChild(loadMore);
  }

  function addArticle(infos) {
    var subreddit = infos.data.subreddit_name_prefixed;
    var domain = infos.data.domain;

    var titleBar = document.createElement('div');
    titleBar.id = infos.data.name + 'title';
    titleBar.style.cssText = 'display: flex;';

    var titleLink = document.createElement('a');
    titleLink.href = 'https://reddit.com/' + subreddit;
    titleLink.textContent = subreddit;
    titleLink.style.cssText = 'width:33%;font-size: 2em;overflow: hidden;';

    var websiteLink = document.createElement('a');
    websiteLink.href = infos.data.url;
    websiteLink.textContent = domain;
    websiteLink.style.cssText = 'width:33%;font-size: 2em;';

    var commentsLink = document.createElement('a');
    commentsLink.href = 'https://reddit.com/'+infos.data.permalink;
    commentsLink.textContent = 'com';
    commentsLink.style.cssText = 'width:33%;font-size: 2em;';

    titleBar.appendChild(titleLink);
    titleBar.appendChild(websiteLink);
    titleBar.appendChild(commentsLink);
    document.body.appendChild(titleBar);

    var node = document.createElement('div');
    node.id = infos.data.name;
    node.style.cssText = 'display: flex;';

    var thumbnail = document.createElement('img');
    thumbnail.style.cssText = 'width:25%; height:10vh;';
    thumbnail.src = infos.data.thumbnail;

    var title = document.createElement('h2');
    title.style.cssText = 'width:75%;';
    title.textContent = infos.data.title;

    node.appendChild(thumbnail);
    node.appendChild(title);
    document.body.appendChild(node);

    document.getElementById(node.id).onclick = function () { addElement(this) };
  }

  function addElement(parentNode) {
    var bigId = parentNode.id + 'big';
    if (document.body.contains(document.getElementById(bigId))) {
      document.getElementById(bigId).remove();
    } else {
      var value = map.get(parentNode.id);
      var infos = JSON.parse(value);

      if (infos.data.is_video) {
        addVideo("100%", "auto", infos.data.secure_media.reddit_video.fallback_url, parentNode);
      } else if (infos.data.url.includes(".gifv")) {
        var videoUrl = infos.data.url.replace(".gifv", ".mp4");
        addVideo("100%", "auto", videoUrl, parentNode);
      } else if (infos.data.url.includes(".jpg")) {
        addImage(infos.data.url, parentNode);
      } else if (!(Object.entries(infos.data.media_embed).length === 0 && infos.data.media_embed.constructor === Object)) {
        // is an embed object
        addEmbedElement(infos.data.media_embed.content, parentNode);
      } else if (infos.data.url.includes("https://imgur.com/")) {
        // received: https://imgur.com/R3cBEif
        // created: https://i.imgur.com/R3cBEif.jpg
        var img = infos.data.url.substring(0, 8) + 'i.' + infos.data.url.substring(8) + '.jpg';
        addImage(img, parentNode);
      } else {
        logger('not yet implemented');
        logger(infos);
      }

    }
  }

  function addEmbedElement(content, parentNode) {
      var embed = document.createElement('div');
      embed.style.cssText = 'width:100%;';
      embed.id = parentNode.id + 'big';
      embed.appendChild(document.createRange().createContextualFragment(unescapeHtml(content)));
      embed.firstChild.style.cssText = 'width:100%;';

      parentNode.parentNode.insertBefore(embed, parentNode.nextSibling);
  }

  function addImage(url, parentNode) {
      var image = document.createElement('img');
      image.style.cssText = 'width:100%;';
      image.src = url;
      image.id = parentNode.id + 'big';

      parentNode.parentNode.insertBefore(image, parentNode.nextSibling);
  }

  function addVideo(width, height, source, parentNode) {
      var video = document.createElement('video');
      video.style.cssText = 'width:100%;';
      video.controls = true;
      video.autoplay = true;
      video.id = parentNode.id + 'big';
      var src = document.createElement('source');
      src.src = source;
      src.type = 'video/mp4';

      video.appendChild(src);

      parentNode.parentNode.insertBefore(video, parentNode.nextSibling);
  }

  function logger(textContent) {
    if (LOGGER === true) {
      console.log(textContent);
    }
  }

  function unescapeHtml(unsafe) {
    return unsafe
        .replace(/&amp;/g, "&")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&quot;/g, "\"")
        .replace(/&#039;/g, "'");
}
</script>

</html>
