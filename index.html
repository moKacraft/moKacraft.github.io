<!DOCTYPE html>
<html>

<head>
  <style>
    /* https://blog.koley.in/2019/339-bytes-of-responsive-css */
  </style>
</head>

<body>
  <h1>Reddit but lighter</h1>
</body>

<script>
  sessionStorage.clear();
  var after;
  //var url = "https://cors-hackity.herokuapp.com/https://reddit.com/r/all/.json?sort=hot&limit=5";
  loadURL("https://cors-hackity.herokuapp.com/https://reddit.com/r/all/.json?sort=hot&limit=5", onDataLoaded);

  function onDataLoaded(object) {
    object = JSON.parse(object);

    for (article in object.data.children) {
      // Add articles infos to session storage
      var infos = object.data.children[article];
      sessionStorage.setItem(infos.data.name, JSON.stringify(infos));

      var node = document.createElement('div');
      node.id = infos.data.name;
      node.style.cssText = 'display: flex;';

      var thumbnail = document.createElement('img');
      thumbnail.style.cssText = 'width:25%;';
      thumbnail.src = infos.data.thumbnail;

      var title = document.createElement('h2');
      title.style.cssText = 'width:75%;';
      title.textContent = infos.data.title;

      node.appendChild(thumbnail);
      node.appendChild(title);
      document.body.appendChild(node);

      document.getElementById(node.id).onclick = function () { addElement(this.id, this) };
    }
    after = object.data.after;
    var url = "https://cors-hackity.herokuapp.com/https://reddit.com/r/all/.json?sort=hot&limit=5&after=" + after;

    var loadMore = document.createElement('button');
    loadMore.id = 'loadMore';
    loadMore.onclick = function () { loadURL(url, onDataLoaded) };
    loadMore.style.cssText = 'height:5vh;width:100vw';
    loadMore.textContent = 'Load more';

    document.body.appendChild(loadMore);
  }

  function addElement(id, parentNode) {
    var value = sessionStorage.getItem(id);
    var infos = JSON.parse(value);
    if (infos.data.is_video) {
      addVideo("100%", "auto", infos.data.secure_media.reddit_video.fallback_url, parentNode);
    } else {
      if (infos.data.url.includes(".gifv")) {
        var videoUrl = infos.data.url.replace(".gifv", ".mp4");
        addVideo("100%", "auto", videoUrl, parentNode);
      } else {
        addImage(infos.data.url, parentNode);
      }
    }
  }

  function loadURL(url, callBack) {
    if (document.getElementById("loadMore")) {
      document.getElementById("loadMore").remove();
    }

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.setRequestHeader("Accept", "application/json");
    xhr.onloadend = onLoadEnd(xhr, callBack);
    xhr.send();
  }

  function onLoadEnd(request, callBack) {
    return function () {
      var status = request.status;
      var result = String(request.response);
      if (status >= 200 && status < 300) callBack(result);
    };
  }

  function addImage(url, parentNode) {
    var bigId = parentNode.id + 'big';
    if (document.body.contains(document.getElementById(bigId))) {
      document.getElementById(bigId).remove();
    } else {
      var image = document.createElement('img');
      image.style.cssText = 'width:100%;';
      image.src = url;
      image.id = bigId;

      parentNode.parentNode.insertBefore(image, parentNode.nextSibling);
    }
  }

  function addVideo(width, height, source, parentNode) {
    var bigId = parentNode.id + 'big';
    if (document.body.contains(document.getElementById(bigId))) {
      document.getElementById(bigId).remove();
    } else {
      var video = document.createElement('video');
      video.style.cssText = 'width:100%;';
      video.controls = true;
      video.autoplay = true;
      video.id = bigId;
      var src = document.createElement('source');
      src.src = source;
      src.type = 'video/mp4';

      video.appendChild(src);

      parentNode.parentNode.insertBefore(video, parentNode.nextSibling);
    }
  }
</script>

</html>
