<!DOCTYPE html>
<html>

<body>
    <h1>Reddit</h1>
    <select onchange="sortChangeEvent(this.value)" id="sort">
        <option value="hot" selected>hot</option>
        <option value="top">top</option>
        <option value="new">new</option>
        <option value="controversial">controversial</option>
    </select>
</body>
<script>
    const LOGGER = true;
    var map = new Map();

    var subreddit = retrieveParametersFormURL().subreddit;
    var sort = retrieveParametersFormURL().sort;
    if (subreddit === undefined) {
        subreddit = 'r/all';
    }
    if (sort === undefined) {
        sort = 'hot';
    } else {
        document.getElementById("sort").value = sort;
    }
    // TODO sort by time
    if (sort === 'top') {
        //document.getElementById("time").value = sort;
    } else {

    }
    var redditUrl = "https://cors-hackity.herokuapp.com/https://reddit.com/" + subreddit + "/" + sort + "/.json?limit=15";
    loadURL("http://localhost:4000/?website=reddit&subreddit=all&sort=hot", onDataLoaded);

    function sortChangeEvent(event) {
        window.location.href = './reddit.html?subreddit=' + subreddit + "&sort=" + event;
    }

    function timeChangeEvent(event) {
        logger('time change event ' + event);
        //window.location.href = './reddit.html?subreddit=' + subreddit + "&sort=" + event;
    }

    function createTimeSelect() {
        //   <select onchange="timeChangeEvent(this.value)" id="time">
        //   <option value="hot" selected>hot</option>
        //   <option value="top">top</option>
        //   <option value="new">new</option>
        //   <option value="controversial">controversial</option>
        // </select>
    }

    function retrieveParametersFormURL() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
            vars[key] = value;
        });
        return vars;
    }

    function loadURL(url, callBack) {
        if (document.getElementById("loadMore")) {
            document.getElementById("loadMore").remove();
        }

        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.setRequestHeader("Accept", "application/json");
        xhr.onloadend = onLoadEnd(xhr, callBack);
        xhr.send();
    }

    function onLoadEnd(request, callBack) {
        return function () {
            var status = request.status;
            var result = String(request.response);
            if (status >= 200 && status < 300) callBack(result);
        };
    }

    function onDataLoaded(object) {
        object = JSON.parse(object);
        object = object.message;
        logger(object);
        for (article in object.data.children) {
            var infos = object.data.children[article];
            map.set(infos.data.name, JSON.stringify(infos));
            addArticle(infos);
        }
        var url = redditUrl + "&after=" + object.data.after;
        addButton('loadMore', 'Load more', 'height:5vh;width:100vw;font-size:3em;', url, function () { loadURL(url, onDataLoaded); });

        //test();
    }


    /* Allow to find element that can't be displayed 
    ** Doesn't work the second time, will close o,nes already opened and open others*/
    function test() {
        map.forEach(element => {
            document.getElementById(JSON.parse(element).data.name + '_content').onclick(this);
            logger(JSON.parse(element).data.name);
        });
    }

    function addButton(id, textContent, cssText, url, callback) {
        var loadMore = document.createElement('button');
        loadMore.id = id;
        loadMore.textContent = textContent;
        loadMore.style.cssText = cssText;
        loadMore.onclick = callback;

        document.body.appendChild(loadMore);
    }

    function createLink(href, textContent, cssText) {
        var link = document.createElement('a');
        link.href = href;
        link.textContent = textContent;
        link.style.cssText = cssText;
        return link;
    }

    function createBulletSpan() {
        var bullet = document.createElement('span');
        bullet.textContent = '‚Ä¢';
        bullet.style.cssText = 'font-size:2em;margin:1vw;';
        return bullet;
    }

    function createDiv(id, cssText) {
        var div = document.createElement('div');
        div.id = id;
        div.style.cssText = cssText;
        return div;
    }

    function addArticle(infos) {
        var article = createDiv(infos.data.name, '');

        var subreddit = infos.data.subreddit_name_prefixed;

        var titleBar = createDiv(infos.data.name + '_title', 'display:flex;');
        var titleLink = createLink('./reddit.html?subreddit=' + subreddit + "&sort=hot", subreddit, 'font-size:2em;overflow:hidden;');
        var websiteLink = createLink(infos.data.url, infos.data.domain, 'font-size:2em;');
        var commentsLink = createLink('https://reddit.com/' + infos.data.permalink, 'üó®Ô∏è ' + infos.data.num_comments, 'font-size:2em;');

        titleBar.appendChild(titleLink);
        titleBar.appendChild(createBulletSpan());
        titleBar.appendChild(websiteLink);
        titleBar.appendChild(createBulletSpan());
        titleBar.appendChild(commentsLink);
        article.appendChild(titleBar);

        var node = createDiv(infos.data.name + '_content', 'display:flex;border-bottom: 1px solid black;width:100vw;');

        var thumbnail = document.createElement('img');
        thumbnail.style.cssText = 'width:25vw;height:10vh;';
        // TODO add src 
        if (infos.data.thumbnail === 'default' || infos.data.thumbnail === 'self' || infos.data.thumbnail === 'image' || infos.data.thumbnail === 'nsfw') {
            //logger(infos);
        } else {
            thumbnail.src = infos.data.thumbnail;
        }

        var title = document.createElement('h2');
        title.style.cssText = 'width:75vw;';
        title.textContent = infos.data.title;

        node.appendChild(thumbnail);
        node.appendChild(title);

        article.appendChild(node);
        document.body.appendChild(article);

        document.getElementById(node.id).onclick = function () { addElement(this); };
    }

    function addElement(parentNode) {
        var bigId = parentNode.id + 'big';
        if (document.body.contains(document.getElementById(bigId))) {
            document.getElementById(bigId).remove();
        } else {
            var value = map.get(parentNode.id.replace('_content', ''));
            var infos = JSON.parse(value);

            if (infos.data.is_video) {
                addVideo("100%", "auto", infos.data.secure_media.reddit_video.fallback_url, parentNode);
            } else if (infos.data.url.includes(".gifv")) {
                var videoUrl = infos.data.url.replace(".gifv", ".webm");
                addVideo("100%", "auto", videoUrl, parentNode);
            } else if (infos.data.url.includes(".jpg") || infos.data.url.includes(".png") || infos.data.url.includes(".gif")) {
                addImage(infos.data.url, parentNode);
            } else if (!(Object.entries(infos.data.secure_media_embed).length === 0 && infos.data.secure_media_embed.constructor === Object)) {
                if (infos.data.url.includes("https://gfycat.com/")) {
                    var str = document.createRange().createContextualFragment(unescapeHtml(infos.data.secure_media_embed.content)).firstElementChild.src;
                    var imageUrl = unescape(str.substring(str.lastIndexOf("ge=") + 3, str.lastIndexOf("key")));
                    var key = imageUrl.substring(imageUrl.lastIndexOf("com/") + 4, imageUrl.lastIndexOf("-size"))
                    addVideo('100%', 'auto', 'https://giant.gfycat.com/' + key + '.webm', parentNode)
                    //logger(key);
                } else {
                    // twitter
                    logger('embed');
                    addEmbedElement(infos.data.secure_media_embed.content, parentNode);
                }
            } else if (infos.data.url.includes("https://imgur.com/")) {
                var img = infos.data.url.substring(0, 8) + 'i.' + infos.data.url.substring(8) + '.jpg';
                addImage(img, parentNode);
            } else if (infos.data.url.includes("https://v.redd.it/")) {
                addVideo("100%", "auto", infos.data.url + '/DASH_720', parentNode);
            } else {
                // crosspost
                // Should add logg to file
                logger('not yet implemented: ' + infos.data.url);
                logger(infos);
            }

        }
    }

    function addEmbedElement(content, parentNode) {
        logger(unescapeHtml(content));
        var embed = createDiv(parentNode.id + 'big', 'width:100vw;');
        embed.appendChild(document.createRange().createContextualFragment(unescapeHtml(content)));
        embed.firstChild.style.cssText = 'width:100vw;';

        parentNode.parentNode.insertBefore(embed, parentNode.nextSibling);
    }

    function addImage(url, parentNode) {
        var image = document.createElement('img');
        image.style.cssText = 'width:100vw;';
        image.src = url;
        image.id = parentNode.id + 'big';

        parentNode.parentNode.insertBefore(image, parentNode.nextSibling);
    }

    function addVideo(width, height, source, parentNode) {
        var video = document.createElement('video');
        video.style.cssText = 'width:100vw;';
        video.controls = true;
        video.autoplay = true;
        video.id = parentNode.id + 'big';
        var src = document.createElement('source');
        src.src = source;
        src.type = 'video/webm';

        video.appendChild(src);

        parentNode.parentNode.insertBefore(video, parentNode.nextSibling);

        // TODO should i add overlay? unecessary work to check type
        // var overlay = document.createElement('img');
        // overlay.style.cssText = 'position:absolute;width:25vw;height:10vh;';
        // overlay.src = 'http://simpleicon.com/wp-content/uploads/play1-256x256.png';

        // parentNode.appendChild(overlay);
    }

    function logger(textContent) {
        if (LOGGER === true) {
            console.log(textContent);
        }
    }

    function unescapeHtml(unsafe) {
        return unsafe
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, "\"")
            .replace(/&#039;/g, "'");
    }
</script>

</html>